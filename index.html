<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Happy Valentine's Day, Sohlange!</title>
<link id="favicon" rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect x='2' y='22' width='2' height='10' fill='%232d8b2d'/><rect x='0' y='26' width='3' height='3' fill='%233da33d'/><rect x='4' y='28' width='3' height='3' fill='%233da33d'/><rect x='8' y='6' width='6' height='6' fill='%23ff4455'/><rect x='18' y='6' width='6' height='6' fill='%23ff4455'/><rect x='4' y='10' width='6' height='6' fill='%23ff4455'/><rect x='22' y='10' width='6' height='6' fill='%23ff4455'/><rect x='6' y='14' width='20' height='6' fill='%23ff4455'/><rect x='10' y='8' width='12' height='6' fill='%23ffaaaa'/><rect x='8' y='18' width='16' height='4' fill='%23ff4455'/><rect x='12' y='12' width='8' height='4' fill='%23ffee44'/><rect x='14' y='14' width='4' height='2' fill='%23ffcc00'/></svg>">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
  @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap');
  *{margin:0;padding:0;box-sizing:border-box;}
  body{overflow:hidden;background:#0d3d0d;font-family:'Press Start 2P',monospace;touch-action:manipulation;}
  canvas{display:block;cursor:pointer;}
  #textLayer{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;display:flex;flex-direction:column;align-items:center;}
  #title{font-family:'Press Start 2P',monospace;color:#ff6b9d;font-size:22px;margin-top:11vh;text-shadow:2px 2px 0 #8b0040,0 0 12px #ff6b9d88;text-align:center;line-height:1.6;animation:pulse 2s ease-in-out infinite;}
  #poem{font-family:'Press Start 2P',monospace;color:#fff;font-size:14px;text-shadow:3px 3px 0 #8b0040,0 0 14px #ff6b9d99,-1px -1px 0 #8b0040,1px -1px 0 #8b0040,-1px 1px 0 #8b0040;text-align:center;line-height:2.4;position:absolute;width:100%;opacity:0;transition:opacity 1.2s ease;pointer-events:none;padding:0 10px;}
  #hint{font-family:'Press Start 2P',monospace;color:#ffee44;font-size:10px;text-shadow:1px 1px 0 #000,0 0 6px #ffee4466;position:absolute;text-align:center;transform:translateX(-50%);white-space:nowrap;pointer-events:none;}
  #hintArrow{position:absolute;transform:translateX(-50%);pointer-events:none;animation:bounce 1s ease-in-out infinite;}
  #muteBtn{position:absolute;bottom:16px;right:16px;font-family:'Press Start 2P',monospace;font-size:9px;color:#ffddee;background:rgba(0,30,0,0.7);border:2px solid #ff6b9d;padding:7px 11px;cursor:pointer;pointer-events:auto;text-shadow:1px 1px 0 #8b0040;border-radius:4px;display:none;z-index:20;}
  #muteBtn:hover{background:rgba(0,50,0,0.9);}
  @keyframes pulse{0%,100%{transform:scale(1);}50%{transform:scale(1.03);}}
  @keyframes bounce{0%,100%{transform:translateX(-50%) translateY(0);}50%{transform:translateX(-50%) translateY(8px);}}
  @media(max-width:600px){#title{font-size:14px;margin-top:8vh;}#poem{font-size:10px;line-height:2.6;}#hint{font-size:8px;}#muteBtn{font-size:7px;padding:5px 9px;bottom:12px;right:12px;}}
</style>
</head>
<body>
<canvas id="c"></canvas>
<div id="textLayer">
  <div id="title">Happy Valentine's Day</div>
  <div id="poem">This field of flowers<br>is just for you!<br><span style="font-family:'Dancing Script',cursive;font-size:28px;color:#fff;display:inline-block;margin-top:12px;">‚ù§Ô∏è Josh</span></div>
  <div id="hint">Tap!</div>
  <div id="hintArrow"><svg width="16" height="20" viewBox="0 0 24 28" fill="none"><rect x="10" y="0" width="4" height="4" fill="#ffee44"/><rect x="10" y="4" width="4" height="4" fill="#ffee44"/><rect x="10" y="8" width="4" height="4" fill="#ffee44"/><rect x="10" y="12" width="4" height="4" fill="#ffee44"/><rect x="2" y="16" width="4" height="4" fill="#ffee44"/><rect x="6" y="16" width="4" height="4" fill="#ffee44"/><rect x="10" y="16" width="4" height="4" fill="#ffee44"/><rect x="14" y="16" width="4" height="4" fill="#ffee44"/><rect x="18" y="16" width="4" height="4" fill="#ffee44"/><rect x="6" y="20" width="4" height="4" fill="#ffee44"/><rect x="10" y="20" width="4" height="4" fill="#ffee44"/><rect x="14" y="20" width="4" height="4" fill="#ffee44"/><rect x="10" y="24" width="4" height="4" fill="#ffee44"/></svg></div>
  <button id="muteBtn">üîä Mute</button>
</div>
<script>
const C=document.getElementById('c'),ctx=C.getContext('2d'),dpr=window.devicePixelRatio||1;
let W,H,isMobile;
function resize(){W=window.innerWidth;H=window.innerHeight;C.width=W*dpr;C.height=H*dpr;C.style.width=W+'px';C.style.height=H+'px';ctx.setTransform(dpr,0,0,dpr,0,0);isMobile=W<600;}
resize();
function pRect(x,y,s,col){ctx.fillStyle=col;ctx.fillRect(Math.floor(x),Math.floor(y),s,s);}
function pBox(x,y,w,h,col){ctx.fillStyle=col;ctx.fillRect(Math.floor(x),Math.floor(y),w,h);}
const LETTERS={S:[[0,1,1,1,0],[1,0,0,0,1],[1,0,0,0,0],[0,1,1,1,0],[0,0,0,0,1],[1,0,0,0,1],[0,1,1,1,0]],O:[[0,1,1,1,0],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[0,1,1,1,0]],H:[[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1]],L:[[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0],[1,1,1,1,1]],A:[[0,0,1,0,0],[0,1,0,1,0],[1,0,0,0,1],[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1]],N:[[1,0,0,0,1],[1,1,0,0,1],[1,0,1,0,1],[1,0,0,1,1],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1]],G:[[0,1,1,1,0],[1,0,0,0,1],[1,0,0,0,0],[1,0,1,1,1],[1,0,0,0,1],[1,0,0,0,1],[0,1,1,1,0]],E:[[1,1,1,1,1],[1,0,0,0,0],[1,0,0,0,0],[1,1,1,1,0],[1,0,0,0,0],[1,0,0,0,0],[1,1,1,1,1]]};
const NAME='SOHLANGE';
const CS=[{bud:'#cc3344',petal:'#ff4455',inner:'#ff8888',mid:'#ffaaaa',center:'#ffcc00'},{bud:'#ccaa00',petal:'#ffdd33',inner:'#ffee88',mid:'#fff5bb',center:'#ff9900'},{bud:'#3366cc',petal:'#4488ff',inner:'#88bbff',mid:'#aaccff',center:'#ffee44'},{bud:'#8833aa',petal:'#aa55dd',inner:'#cc99ee',mid:'#ddbbff',center:'#ffcc00'},{bud:'#cc3344',petal:'#ff4455',inner:'#ff8888',mid:'#ffaaaa',center:'#ffcc00'},{bud:'#ccaa00',petal:'#ffdd33',inner:'#ffee88',mid:'#fff5bb',center:'#ff9900'},{bud:'#3366cc',petal:'#4488ff',inner:'#88bbff',mid:'#aaccff',center:'#ffee44'},{bud:'#8833aa',petal:'#aa55dd',inner:'#cc99ee',mid:'#ddbbff',center:'#ffcc00'}];

// === CLOUDS ===
let clouds=[];
function initClouds(){clouds=[];for(let i=0;i<6;i++){let cw=50+Math.random()*70;clouds.push({x:Math.random()*W*1.3-W*0.15,y:H*0.03+Math.random()*H*0.16,w:cw,speed:0.12+Math.random()*0.2});}}
function drawCloudShape(cx,cy,w,sc){let h=w*0.4*sc;pBox(cx-w*0.45,cy,w*0.9,h*0.6,ctx.fillStyle);pBox(cx-w*0.4,cy+h*0.5,w*0.8,h*0.3,ctx.fillStyle);let pr=h*0.7;pBox(cx-pr*0.6,cy-pr*0.7,pr*1.2,pr,ctx.fillStyle);pBox(cx-pr*0.45,cy-pr*0.9,pr*0.9,pr*0.5,ctx.fillStyle);let lr=h*0.55;pBox(cx-w*0.35-lr*0.3,cy-lr*0.4,lr*1.1,lr,ctx.fillStyle);pBox(cx-w*0.35-lr*0.15,cy-lr*0.6,lr*0.8,lr*0.4,ctx.fillStyle);let rr=h*0.6;pBox(cx+w*0.2-rr*0.2,cy-rr*0.5,rr*1.1,rr,ctx.fillStyle);pBox(cx+w*0.2,cy-rr*0.7,rr*0.7,rr*0.4,ctx.fillStyle);let sl=h*0.35;pBox(cx-w*0.45,cy-sl*0.2,sl,sl*0.8,ctx.fillStyle);pBox(cx+w*0.35,cy-sl*0.1,sl*0.9,sl*0.7,ctx.fillStyle);pBox(cx-w*0.4,cy-h*0.2,w*0.8,h*0.5,ctx.fillStyle);}
function drawCloud(c){let s=isMobile?0.7:1,w=c.w*s;ctx.fillStyle='#b8d8ee';drawCloudShape(c.x+2,c.y+3,w,0.9);ctx.fillStyle='#ffffff';drawCloudShape(c.x,c.y,w,1);ctx.fillStyle='#f0f8ff';drawCloudShape(c.x-1,c.y-2,w*0.7,0.6);}

// === CHIPMUNK ===
let chip={active:false,x:0,y:0,speed:0,frame:0,dir:-1};
function startChipmunk(){chip={active:true,x:W+40,y:H*0.75,speed:isMobile?2.5:3.5,frame:0,dir:-1};}
function getRandomFieldY(){let zones=[[H*0.31,H*0.37],[H*0.57,H*0.85]];let z=Math.random()<0.8?zones[1]:zones[0];return z[0]+Math.random()*(z[1]-z[0]);}
function startChipmunkRandom(){let fr=Math.random()>0.5;let yPos=getRandomFieldY();let willTurn=Math.random()<0.4;let turnX=W*(0.25+Math.random()*0.5);chip={active:true,x:fr?W+40:-40,y:yPos,speed:isMobile?2.5:3.5,frame:0,dir:fr?-1:1,willTurn:willTurn,turnX:turnX,turned:false,pauseTimer:0,pausing:false};}
function updateChipmunk(){if(!chip.active)return;if(chip.pausing){chip.pauseTimer++;if(chip.pauseTimer>25){chip.pausing=false;chip.dir*=-1;chip.turned=true;}return;}chip.x+=chip.speed*chip.dir;chip.frame+=0.18;if(chip.willTurn&&!chip.turned){let atTurn=chip.dir>0?(chip.x>=chip.turnX):(chip.x<=chip.turnX);if(atTurn){chip.pausing=true;chip.pauseTimer=0;}}if(chip.dir<0&&chip.x<-60)chip.active=false;if(chip.dir>0&&chip.x>W+60)chip.active=false;}
function drawChipmunk(){if(!chip.active)return;let px=chip.x,py=chip.y,sc=isMobile?0.8:1.3,lf=chip.pausing?0:Math.floor(chip.frame)%2,f=chip.dir<0?1:-1;ctx.save();ctx.translate(px,py);ctx.scale(f*sc,sc);pBox(12,-4,3,4,'#8B6914');pBox(13,-8,4,6,'#A07830');pBox(14,-12,4,5,'#8B6914');pBox(13,-14,3,4,'#A07830');pBox(14,-10,2,6,'#6B5010');pBox(11,-6,3,3,'#B08838');if(lf===0){pBox(4,7,3,3,'#8B6914');pBox(7,7,3,3,'#8B6914');pBox(3,9,3,2,'#7a5a12');pBox(7,9,3,2,'#7a5a12');}else{pBox(5,7,3,3,'#8B6914');pBox(6,7,3,3,'#8B6914');pBox(4,9,3,2,'#7a5a12');pBox(6,9,3,2,'#7a5a12');}pBox(-3,-1,14,10,'#B08838');pBox(-4,1,15,7,'#C09848');pBox(-1,2,8,5,'#E8D8B8');pBox(-2,-1,11,2,'#6B4810');pBox(-1,1,9,1,'#E8D8B8');pBox(-2,2,11,1,'#6B4810');pBox(-1,3,9,1,'#E8D8B8');pBox(-2,4,11,1,'#6B4810');if(lf===0){pBox(-5,5,2,4,'#A07830');pBox(-6,8,2,2,'#7a5a12');}else{pBox(-4,5,2,4,'#A07830');pBox(-5,8,2,2,'#7a5a12');}pBox(-9,-6,9,9,'#C09848');pBox(-10,-4,10,6,'#C9A858');pBox(-11,-2,4,4,'#E0C880');pBox(-11,-1,3,3,'#E8D8A0');pBox(-8,-7,7,2,'#A07830');pBox(-8,-4,7,1,'#4A3008');pBox(-7,-4,2,2,'#000000');pBox(-7,-5,1,1,'#ffffff');pBox(-12,-2,2,1,'#dd8899');pBox(-11,0,2,1,'#8B6914');pBox(-7,-8,2,3,'#B08838');pBox(-6,-7,1,1,'#E0C0A0');pBox(-3,-8,2,3,'#B08838');pBox(-2,-7,1,1,'#E0C0A0');ctx.restore();}

// === GEESE ===
let geese={active:false,birds:[]};
function startGeese(){geese.active=true;geese.birds=[];let sc=isMobile?1:1.8,sy=H*0.12;let pos=[{ox:0,oy:0},{ox:16,oy:-10},{ox:16,oy:10},{ox:32,oy:-20},{ox:32,oy:20},{ox:48,oy:-30},{ox:48,oy:30},{ox:64,oy:-40},{ox:64,oy:40}];for(let p of pos)geese.birds.push({x:-80-p.ox*sc,y:sy+p.oy*sc,speed:-((isMobile?1.5:2.2)+Math.random()*0.15),frame:Math.random()*Math.PI*2,wingSpeed:0.04+Math.random()*0.01,sc:sc*(0.9+Math.random()*0.2)});}
function startGeeseRandom(){geese.active=true;geese.birds=[];let sc=isMobile?1:1.8,fr=Math.random()>0.5,sy=H*(0.04+Math.random()*0.12);let pos=[{ox:0,oy:0},{ox:16,oy:-10},{ox:16,oy:10},{ox:32,oy:-20},{ox:32,oy:20},{ox:48,oy:-30},{ox:48,oy:30},{ox:64,oy:-40},{ox:64,oy:40}];for(let p of pos){let sx=fr?W+60+p.ox*sc:-80-p.ox*sc;geese.birds.push({x:sx,y:sy+p.oy*sc,speed:((isMobile?1.5:2.2)+Math.random()*0.15)*(fr?1:-1),frame:Math.random()*Math.PI*2,wingSpeed:0.04+Math.random()*0.01,sc:sc*(0.9+Math.random()*0.2)});}}
function updateGeese(){if(!geese.active)return;let done=true;geese.birds.forEach(b=>{b.x-=b.speed;b.frame+=b.wingSpeed;if(b.speed>0&&b.x>-80)done=false;if(b.speed<0&&b.x<W+80)done=false;});if(done)geese.active=false;}
function drawGoose(b){let s=b.sc,wu=Math.sin(b.frame*4)>0,f=b.speed>0?1:-1;ctx.save();ctx.translate(b.x,b.y);ctx.scale(f*s,s);pBox(-6,-2,14,5,'#2a2a2a');pBox(-4,-3,10,7,'#333333');pBox(-10,-8,5,8,'#1a1a1a');pBox(-11,-11,4,5,'#1a1a1a');pBox(-13,-14,6,5,'#1a1a1a');pBox(-14,-12,7,3,'#1a1a1a');pBox(-13,-12,3,2,'#ffffff');pBox(-12,-13,1,1,'#000000');pBox(-16,-11,3,2,'#333333');pBox(7,-3,4,3,'#2a2a2a');pBox(9,-2,3,2,'#1a1a1a');if(wu){pBox(-3,-7,12,4,'#444444');pBox(-1,-10,9,4,'#555555');pBox(1,-12,6,3,'#666666');}else{pBox(-3,1,12,4,'#444444');pBox(-1,4,9,3,'#555555');pBox(1,6,6,2,'#666666');}pBox(5,2,4,2,'#dddddd');ctx.restore();}
function drawGeese(){if(!geese.active)return;geese.birds.forEach(b=>drawGoose(b));}

// === KANGAROO ===
let roo={active:false,x:0,y:0,baseY:0,speed:0,frame:0,dir:-1,sc:1,hopPhase:0};
function startKangaroo(){let sc=isMobile?1.2:2;let yPos=H*0.32;roo={active:true,x:W+50,y:yPos,baseY:yPos,speed:isMobile?1.5:2.2,frame:0,dir:-1,sc:sc,hopPhase:0};}
function startKangarooRandom(){let sc=isMobile?1.2:2;let fromRight=Math.random()>0.5;let yPos=getRandomFieldY();roo={active:true,x:fromRight?W+50:-50,y:yPos,baseY:yPos,speed:isMobile?1.5:2.2,frame:0,dir:fromRight?-1:1,sc:sc,hopPhase:0};}
function updateKangaroo(){if(!roo.active)return;roo.x+=roo.speed*roo.dir;roo.hopPhase+=0.07;roo.y=roo.baseY-Math.abs(Math.sin(roo.hopPhase))*(isMobile?18:30);roo.frame+=0.07;if(roo.dir<0&&roo.x<-60)roo.active=false;if(roo.dir>0&&roo.x>W+60)roo.active=false;}
function drawKangaroo(t){if(!roo.active)return;let px=roo.x,py=roo.y,sc=roo.sc;let inAir=Math.abs(Math.sin(roo.hopPhase))>0.4;ctx.save();ctx.translate(px,py);ctx.scale(-roo.dir*sc,sc);pBox(12,4,5,4,'#aa7744');pBox(16,2,5,3,'#996633');pBox(20,0,4,3,'#996633');pBox(23,-2,4,2,'#885522');pBox(26,-3,3,2,'#885522');pBox(28,-4,2,2,'#774411');if(inAir){pBox(2,2,6,5,'#aa7744');pBox(0,0,5,5,'#bb8855');pBox(-2,4,7,3,'#aa7744');pBox(-3,3,3,2,'#996633');}else{pBox(4,4,5,10,'#aa7744');pBox(3,6,4,8,'#bb8855');pBox(-4,14,10,3,'#aa7744');pBox(-5,13,4,2,'#996633');pBox(-6,14,2,2,'#996633');}pBox(-2,-8,14,16,'#bb8855');pBox(-4,-6,16,12,'#cc9966');pBox(-3,-4,14,8,'#cc9966');pBox(0,-2,8,8,'#ddbb88');pBox(1,0,6,6,'#ddcc99');  ctx.fillStyle='#ccaa77';ctx.beginPath();ctx.ellipse(4,4,4,3,0,0,Math.PI);ctx.fill();pBox(1,3,7,2,'#bb9966');
    // Baby joey peeking out
    // Joey body in pouch
    pBox(1,0,7,4,'#ddbb88');
    // Joey head - round
    pBox(2,-4,6,6,'#ddcc99');
    pBox(3,-3,5,4,'#e0d0a0');
    // Joey ears - tiny upright
    pBox(2,-6,2,3,'#ccaa77');
    pBox(3,-5,1,1,'#e8c8a8');
    pBox(6,-6,2,3,'#ccaa77');
    pBox(6,-5,1,1,'#e8c8a8');
    // Joey eyes - cute round
    pBox(3,-2,1.5,1.5,'#222');
    pBox(5.5,-2,1.5,1.5,'#222');
    pBox(3,-2.5,1,1,'#fff');
    pBox(5.5,-2.5,1,1,'#fff');
    // Joey nose
    pBox(4.5,-0.5,1,1,'#775544');
    // Joey mouth
    pBox(4,0.5,2,0.5,'#997766');
    // Joey paws gripping pouch edge
    pBox(1,2,2,2,'#ddcc99');
    pBox(0,2,1,1.5,'#ccbb88');
    pBox(7,2,2,2,'#ddcc99');
    pBox(8,2,1,1.5,'#ccbb88');if(inAir){pBox(-5,-2,3,4,'#aa7744');pBox(-6,0,3,3,'#bb8855');}else{pBox(-5,0,3,6,'#aa7744');pBox(-6,4,3,3,'#bb8855');}pBox(-5,-12,7,6,'#cc9966');pBox(-4,-11,5,4,'#cc9966');pBox(-9,-19,10,9,'#cc9966');pBox(-10,-17,11,6,'#ddaa77');pBox(-11,-16,12,4,'#ddaa77');pBox(-13,-15,5,5,'#ddbb88');pBox(-15,-14,4,3,'#ddbb88');pBox(-16,-13,2,2,'#443322');pBox(-14,-11,4,1,'#885544');pBox(-7,-17,2,2,'#000000');pBox(-7,-18,1,1,'#ffffff');pBox(-6,-17,1,1,'#332211');pBox(-8,-18,3,1,'#aa7744');pBox(-7,-24,3,6,'#cc9966');pBox(-6,-23,2,4,'#ffbbaa');pBox(-2,-24,3,6,'#cc9966');pBox(-1,-23,2,4,'#ffbbaa');pBox(-7,-25,2,2,'#bb8855');pBox(-2,-25,2,2,'#bb8855');ctx.restore();}

// === DUCK ===
let duck={active:false,x:0,y:0,speed:1.2,state:'walk',frame:0,timer:0,quackTimer:0,quackCount:0,dir:1,walkDir:1,scale:1};
let babies=[];
function startDuck(){let sc=isMobile?1.5:2.5;duck={active:true,x:-40*sc,y:H*0.60,speed:isMobile?0.8:1.2,state:'walk',frame:0,timer:0,quackTimer:0,quackCount:0,quackBubble:0,dir:-1,walkDir:1,scale:sc,midX:W*0.5,lateDuck:false};babies=[];let sp=(isMobile?18:28)*sc;for(let i=0;i<3;i++)babies.push({x:duck.x-(i+1)*sp*duck.walkDir,y:duck.y+(isMobile?6:10),frame:Math.random()*2,wobble:Math.random()*Math.PI*2,late:false});}
function startDuckRandom(){let sc=isMobile?1.5:2.5,fl=Math.random()>0.5,yp=getRandomFieldY();let willQuack=Math.random()<0.25;duck={active:true,x:fl?-40*sc:W+40*sc,y:yp,speed:isMobile?0.8:1.2,state:'walk',frame:0,timer:0,quackTimer:0,quackCount:willQuack?0:1,quackBubble:0,dir:fl?-1:1,walkDir:fl?1:-1,scale:sc,midX:W*(0.3+Math.random()*0.4)};babies=[];let sp=(isMobile?18:28)*sc;for(let i=0;i<3;i++)babies.push({x:duck.x-(i+1)*sp*duck.walkDir,y:duck.y+(isMobile?6:10),frame:Math.random()*2,wobble:Math.random()*Math.PI*2});}
function updateDuck(){if(!duck.active)return;let d=duck,wd=d.walkDir;d.timer++;if(d.state==='walk'){d.x+=d.speed*wd;d.frame+=0.08;if(d.quackCount===0){let at=wd>0?(d.x>=d.midX-20):(d.x<=d.midX+20);if(at){d.state='quack';d.quackTimer=0;d.quackBubble=0;d.quackCount=1;}}if((wd>0&&d.x>W+60*d.scale)||(wd<0&&d.x<-60*d.scale))d.active=false;}else if(d.state==='quack'){d.quackTimer++;d.quackBubble=Math.min(d.quackTimer/30,1);if(d.quackTimer>120){d.state='walk';d.quackBubble=0;}}
  let sp=(isMobile?18:28)*d.scale;
  let bunchSp=sp*0.4; // tight spacing when stopped
  babies.forEach((b,i)=>{
    let ty=d.y+(isMobile?6:10);
    if(b.late){
      // Late duckling runs faster to catch up
      let lateTarget=d.x-(3)*sp*wd;
      let dist=Math.abs(b.x-lateTarget);
      let catchSpeed=dist>sp*0.8?0.12:0.06;
      b.x+=(lateTarget-b.x)*catchSpeed;
      b.frame+=dist>sp?0.2:0.1;
    }else{
      let normalTarget=d.x-(i+1)*sp*wd;
      let bunchTarget=d.x-(i+1)*bunchSp*wd;
      if(d.state==='walk'){b.x+=(normalTarget-b.x)*0.06;b.frame+=0.1;}
      else{b.x+=(bunchTarget-b.x)*0.08;}
    }
    b.y+=(ty-b.y)*0.06;
  });}
function drawBabyDuck(b){let d=duck,s=d.scale*0.5,lf=Math.floor(b.frame)%2;ctx.save();ctx.translate(b.x,b.y);ctx.scale(d.dir*s,s);if(d.state==='walk'){if(lf===0){pBox(-2,10,3,2,'#ff8800');pBox(4,9,3,2,'#ff8800');}else{pBox(-1,9,3,2,'#ff8800');pBox(3,10,3,2,'#ff8800');}}else{pBox(-1,10,3,2,'#ff8800');pBox(3,10,3,2,'#ff8800');}pBox(-1,8,2,3,'#ff8800');pBox(3,8,2,3,'#ff8800');pBox(-4,0,14,10,'#ffdd44');pBox(-5,2,16,6,'#ffdd44');pBox(-3,5,12,3,'#eebb33');pBox(6,2,3,5,'#eebb33');pBox(-8,-6,8,7,'#ffdd44');pBox(-9,-4,10,5,'#ffdd44');pBox(-6,-4,2,2,'#000000');pBox(-11,-3,3,2,'#ffaa00');ctx.restore();}
function drawDuck(t){if(!duck.active)return;let d=duck,s=d.scale,px=d.x,py=d.y,lf=Math.floor(d.frame)%2;ctx.save();ctx.translate(px,py);ctx.scale(d.dir*s,s);if(d.state==='walk'){if(lf===0){pBox(-4,14,4,3,'#ff8800');pBox(6,12,4,3,'#ff8800');}else{pBox(-2,12,4,3,'#ff8800');pBox(4,14,4,3,'#ff8800');}}else{pBox(-3,14,4,3,'#ff8800');pBox(5,14,4,3,'#ff8800');}pBox(-2,11,3,4,'#ff8800');pBox(5,11,3,4,'#ff8800');pBox(-6,0,18,12,'#ffffff');pBox(-8,2,22,8,'#ffffff');pBox(-5,6,16,4,'#eeeedd');pBox(8,2,4,8,'#ddddcc');pBox(10,3,3,6,'#ccccbb');if(d.state==='quack'&&Math.floor(d.quackBubble*6)%2===0){pBox(10,0,4,6,'#ddddcc');pBox(12,1,3,4,'#ccccbb');}pBox(12,0,3,3,'#ffffff');pBox(14,-1,2,2,'#eeeeee');pBox(-8,-4,6,6,'#ffffff');pBox(-12,-10,10,8,'#ffffff');pBox(-14,-8,14,6,'#ffffff');pBox(-10,-8,2,2,'#000000');pBox(-10,-9,2,1,'#ffffff');if(d.state==='quack'&&d.quackBubble>0){pBox(-16,-6,5,2,'#ffaa00');pBox(-16,-4,6,2,'#ff8800');pBox(-16,-2,5,2,'#ffaa00');}else{pBox(-16,-5,5,2,'#ffaa00');pBox(-16,-3,6,2,'#ff8800');}ctx.restore();if(d.state==='quack'&&d.quackBubble>0.2){let wd=d.walkDir||1,bx=px+25*s*wd,byy=py-20*s,ba=Math.min((d.quackBubble-0.2)*3,1);ctx.globalAlpha=ba;let bw=isMobile?28:40,bh=isMobile?14:20;ctx.fillStyle='#ffffff';ctx.beginPath();ctx.ellipse(bx,byy,bw,bh,0,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.moveTo(bx-8*wd,byy+bh-2);ctx.lineTo(bx-14*wd,byy+bh+8);ctx.lineTo(bx-2*wd,byy+bh-1);ctx.closePath();ctx.fill();ctx.fillStyle='#333';ctx.font=(isMobile?'6':'8')+'px "Press Start 2P",monospace';ctx.textAlign='center';ctx.fillText('QUACK!',bx,byy+3);ctx.globalAlpha=1;}babies.forEach(b=>drawBabyDuck(b));}

// === PIZZA RAT ===
let pRat={active:false,x:0,y:0,speed:0,frame:0,dir:1};
function startPizzaRat(){let fromLeft=Math.random()>0.5;let sc=isMobile?1:1.6;pRat={active:true,x:fromLeft?-30:W+30,y:H-(isMobile?10:15),speed:(isMobile?1.8:2.5),frame:0,dir:fromLeft?1:-1,sc:sc,hasPizza:Math.random()<0.6};}
function updatePizzaRat(){if(!pRat.active)return;pRat.x+=pRat.speed*pRat.dir;pRat.frame+=0.18;if(pRat.dir>0&&pRat.x>W+40)pRat.active=false;if(pRat.dir<0&&pRat.x<-40)pRat.active=false;}
function drawPizzaRat(t){if(!pRat.active)return;let px=pRat.x,py=pRat.y,sc=pRat.sc;let lf=Math.floor(pRat.frame)%2;ctx.save();ctx.translate(px,py);ctx.scale(-pRat.dir*sc,sc);ctx.strokeStyle='#cc8899';ctx.lineWidth=1.5;ctx.beginPath();ctx.moveTo(10,0);let tw=Math.sin(t*0.006)*3;ctx.quadraticCurveTo(16,tw-4,20,-8+tw);ctx.quadraticCurveTo(23,-12+tw,21,-16);ctx.stroke();if(lf===0){pBox(4,6,3,3,'#777');pBox(7,5,3,3,'#777');}else{pBox(5,5,3,3,'#777');pBox(6,6,3,3,'#777');}pBox(-4,-2,16,10,'#888');pBox(-3,0,14,7,'#999');pBox(-1,2,10,4,'#aaa');if(lf===0){pBox(-6,5,3,3,'#888');pBox(-4,6,3,3,'#888');}else{pBox(-5,6,3,3,'#888');pBox(-5,5,3,3,'#888');}pBox(-10,-5,8,9,'#999');pBox(-12,-3,9,6,'#aaa');pBox(-14,-2,4,4,'#aaa');pBox(-15,-1,2,2,'#ff8899');pBox(-8,-4,2,2,'#000');pBox(-8,-5,1,1,'#fff');pBox(-7,-7,3,3,'#999');pBox(-6,-6,2,2,'#ffaaaa');pBox(-3,-7,3,3,'#999');pBox(-2,-6,2,2,'#ffaaaa');
  if(pRat.hasPizza){
    ctx.save();ctx.translate(-18,-3);ctx.rotate(-0.25);
    // Shadow under pizza
    ctx.globalAlpha=0.2;ctx.fillStyle='#000';
    ctx.beginPath();ctx.moveTo(0,-9);ctx.lineTo(-10,7);ctx.lineTo(10,7);ctx.closePath();ctx.fill();
    ctx.globalAlpha=1;
    // Crust - thick curved bottom edge
    ctx.fillStyle='#a86b18';
    ctx.beginPath();ctx.moveTo(-11,5);ctx.quadraticCurveTo(0,11,11,5);ctx.lineTo(10,3);ctx.quadraticCurveTo(0,8,-10,3);ctx.closePath();ctx.fill();
    // Crust top edge highlight
    ctx.fillStyle='#c8922e';
    ctx.beginPath();ctx.moveTo(-9,4);ctx.quadraticCurveTo(0,7,9,4);ctx.lineTo(9,3);ctx.quadraticCurveTo(0,6,-9,3);ctx.closePath();ctx.fill();
    // Crust bottom baked dark
    ctx.fillStyle='#8a5510';
    ctx.beginPath();ctx.moveTo(-10,6);ctx.quadraticCurveTo(0,10,10,6);ctx.lineTo(10,7);ctx.quadraticCurveTo(0,11,-10,7);ctx.closePath();ctx.fill();
    // Sauce layer
    ctx.fillStyle='#cc2200';
    ctx.beginPath();ctx.moveTo(0,-8);ctx.lineTo(-9,3);ctx.lineTo(9,3);ctx.closePath();ctx.fill();
    // Cheese - main layer
    ctx.fillStyle='#ffc620';
    ctx.beginPath();ctx.moveTo(0,-7);ctx.lineTo(-8,2.5);ctx.lineTo(8,2.5);ctx.closePath();ctx.fill();
    // Cheese - lighter melted patches
    ctx.fillStyle='#ffd84a';
    ctx.beginPath();ctx.moveTo(-2,-4);ctx.lineTo(-6,2);ctx.lineTo(1,1);ctx.closePath();ctx.fill();
    ctx.beginPath();ctx.moveTo(1,-3);ctx.lineTo(3,2);ctx.lineTo(7,1);ctx.closePath();ctx.fill();
    // Cheese stringy drip from tip
    ctx.fillStyle='#ffc620';
    ctx.beginPath();ctx.moveTo(-0.5,-8);ctx.lineTo(0.5,-8);ctx.lineTo(0.5,-12);ctx.quadraticCurveTo(0,-11,-0.5,-12);ctx.closePath();ctx.fill();
    // Second smaller drip
    ctx.fillStyle='#ffb810';
    pBox(-0.3,-13,1,2,'#ffb810');
    // Pepperoni 1 - left
    ctx.fillStyle='#991100';
    ctx.beginPath();ctx.arc(-3.5,0,2.8,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#bb2211';
    ctx.beginPath();ctx.arc(-3.5,-0.3,2,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#cc3322';
    ctx.beginPath();ctx.arc(-3.8,-0.6,1,0,Math.PI*2);ctx.fill();
    // Pepperoni 2 - right
    ctx.fillStyle='#991100';
    ctx.beginPath();ctx.arc(3,0.5,2.5,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#bb2211';
    ctx.beginPath();ctx.arc(3,0.2,1.7,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#cc3322';
    ctx.beginPath();ctx.arc(2.7,-0.1,0.8,0,Math.PI*2);ctx.fill();
    // Pepperoni 3 - top small
    ctx.fillStyle='#991100';
    ctx.beginPath();ctx.arc(-0.5,-3,1.8,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#bb2211';
    ctx.beginPath();ctx.arc(-0.5,-3.3,1.2,0,Math.PI*2);ctx.fill();
    // Cheese bubbles/browning spots
    ctx.globalAlpha=0.4;
    ctx.fillStyle='#ee9900';
    ctx.beginPath();ctx.arc(-5,-1,1,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(5,-1,0.8,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(1,1.5,0.7,0,Math.PI*2);ctx.fill();
    ctx.globalAlpha=1;
    // Sauce peeking at edges
    ctx.fillStyle='#cc2200';
    pBox(-8,2,1.5,1.5,'#cc2200');
    pBox(7,2,1.5,1.5,'#cc2200');
    ctx.restore();
  }
  ctx.restore();}

// === RANDOM ANIMAL SPAWNER ===
let animalTimer=0,animalInterval=200;
function spawnRandomAnimal(){let avail=[];if(!duck.active)avail.push('duck','duck','duck');if(!chip.active)avail.push('chip','chip','chip');if(!geese.active)avail.push('geese','geese','geese');if(!roo.active)avail.push('roo','roo');if(!pRat.active)avail.push('rat');if(avail.length===0)return;let pick=avail[Math.floor(Math.random()*avail.length)];if(pick==='duck')startDuckRandom();else if(pick==='chip')startChipmunkRandom();else if(pick==='geese')startGeeseRandom();else if(pick==='roo')startKangarooRandom();else startPizzaRat();}

// === SNOW ===
let snowFlakes=[],fallingSnow=[];
function initSnow(){snowFlakes=[];fallingSnow=[];let skyBot=H*(isMobile?0.28:0.30);
  // Extra dense snow at horizon
  for(let x=0;x<W;x+=2){snowFlakes.push({x:x,y:skyBot-4+Math.random()*10,size:4+Math.random()*5,bright:0.8+Math.random()*0.2});}
  // Rest of field
  for(let x=0;x<W;x+=2){let y=skyBot+10+Math.random()*(H-skyBot-10);if(Math.random()<0.75)snowFlakes.push({x:x+Math.random()*2,y:y,size:3+Math.random()*5,bright:0.7+Math.random()*0.3});}
  for(let i=0;i<(isMobile?40:80);i++){fallingSnow.push({x:Math.random()*W,y:Math.random()*H,size:isMobile?1+Math.random()*2:2+Math.random()*3,speed:0.3+Math.random()*0.8,drift:Math.random()*Math.PI*2,driftSpeed:0.002+Math.random()*0.003,bright:0.5+Math.random()*0.5});}}

// === AUDIO ===
const MUSIC_URL = 'Fearless_8bit(Taylors Version).mp3';
let audio=null,musicPlaying=false;
function startMusic(){
  if(audio)return;
  audio=new Audio(MUSIC_URL);
	audio.volume = 0.25;
  audio.loop=true;
  audio.play().catch(()=>{});
  musicPlaying=true;
  let btn=document.getElementById('muteBtn');
  btn.style.display='block';
  btn.textContent='üîä Mute';
}
// üîπ Pause when tab is hidden, resume when visible
document.addEventListener('visibilitychange', () => {
  if (!audio) return;

  if (document.hidden) {
    audio.pause();
  } else if (musicPlaying) {
    audio.play().catch(()=>{});
  }
});

// üîπ Stop completely when page is closed or refreshed
window.addEventListener('beforeunload', () => {
  if (!audio) return;
  audio.pause();
  audio.src = '';
  audio = null;
});
document.getElementById('muteBtn').addEventListener('click',function(){
  if(!audio)return;
  if(musicPlaying){audio.pause();musicPlaying=false;this.textContent='üîá Umute';}
  else{audio.play();musicPlaying=true;this.textContent='üîä Mute';}
// === SKY STATE ===
let sunProg=0,sunRising=false;
function lerpC(a,b,t){let ar=parseInt(a.slice(1,3),16),ag=parseInt(a.slice(3,5),16),ab=parseInt(a.slice(5,7),16),br=parseInt(b.slice(1,3),16),bg=parseInt(b.slice(3,5),16),bb=parseInt(b.slice(5,7),16);return '#'+Math.round(ar+(br-ar)*t).toString(16).padStart(2,'0')+Math.round(ag+(bg-ag)*t).toString(16).padStart(2,'0')+Math.round(ab+(bb-ab)*t).toString(16).padStart(2,'0');}

// === BG FLOWERS ===
let bgFlowers=[],bgFQ=[],skyH=0;
function makeBgPos(){let p=[];const sp=isMobile?24:30,bs=isMobile?36:55;const tw=NAME.length*bs,sx=(W-tw)/2,by=H*0.48,mg=isMobile?3:5;skyH=H*(isMobile?0.28:0.30);let bz={x:sx-mg,y:by-(isMobile?60:90),w:tw+mg*2,h:isMobile?80:115};for(let gy=Math.floor(skyH);gy<H+sp;gy+=sp)for(let gx=-20;gx<W+sp;gx+=sp){let jx=gx+(Math.random()-0.5)*sp*0.7,jy=gy+(Math.random()-0.5)*sp*0.7;if(jy<skyH+10)continue;if(jx>bz.x&&jx<bz.x+bz.w&&jy>bz.y&&jy<bz.y+bz.h)continue;p.push({x:jx,y:jy});}for(let i=p.length-1;i>0;i--){let j=Math.floor(Math.random()*(i+1));[p[i],p[j]]=[p[j],p[i]];}return p;}
let allPos=[],posIdx=0,clickNum=0;
function spawnBgBatch(c){
  clickNum++;
  // First clicks: fewer flowers, more saplings. Later: more flowers
  let fraction;
  if(clickNum===1)fraction=0.04;
  else if(clickNum===2)fraction=0.06;
  else if(clickNum===3)fraction=0.08;
  else if(clickNum<=5)fraction=0.14;
  else fraction=0.18;
  let n=Math.ceil(allPos.length*fraction);
  let cols=[c.petal,c.inner,c.mid,c.bud];
  let saplingChance=clickNum<=2?0.6:clickNum<=4?0.3:0.05;
  for(let i=0;i<n&&posIdx<allPos.length;i++,posIdx++){let p=allPos[posIdx];
    let isSapling=Math.random()<saplingChance;
    bgFQ.push({x:p.x,y:p.y,size:(isMobile?2:3)+Math.floor(Math.random()*(isMobile?3:5)),col:isSapling?['#3da33d','#44aa44','#55bb55','#2d8b2d'][Math.floor(Math.random()*4)]:cols[Math.floor(Math.random()*cols.length)],phase:Math.random()*Math.PI*2,type:isSapling?4:Math.floor(Math.random()*4),stemH:(isMobile?6:8)+Math.random()*(isMobile?10:16),gp:0,gs:0.02+Math.random()*0.02,delay:i*2+Math.random()*20});}}

// === BUDS ===
let buds=[],allDone=false,revT=0,hearts=[],sparkles=[];
function initBuds(){buds=[];const sp=isMobile?36:55,tw=NAME.length*sp,sx=(W-tw)/2,by=H*0.48+(isMobile?12:20);for(let i=0;i<NAME.length;i++){let c=CS[i];buds.push({x:sx+i*sp+sp/2,y:by,drawX:sx+i*sp+sp/2,drawY:by,stemH:isMobile?45+Math.random()*12:65+Math.random()*20,drawStemH:0,letter:NAME[i],bloomed:false,bloomProgress:0,visible:i===0,growIn:i===0?1:0,wobble:Math.random()*Math.PI*2,budCol:c.bud,petalCol:c.petal,innerCol:c.inner,midCol:c.mid,centerCol:c.center,leafPhase:Math.random()*Math.PI});buds[i].drawStemH=buds[i].stemH;}}
function updateHint(){let h=document.getElementById('hint'),a=document.getElementById('hintArrow');if(allDone){h.style.display='none';a.style.display='none';return;}let idx=-1;for(let i=0;i<buds.length;i++)if(!buds[i].bloomed&&buds[i].visible&&buds[i].growIn>=0.9){idx=i;break;}if(idx<0){h.style.display='none';a.style.display='none';return;}let b=buds[idx],topY=b.y-b.stemH*b.growIn*0.3-(isMobile?10:14);h.style.top=(topY-(isMobile?58:78))+'px';h.style.left=b.x+'px';h.style.display='block';a.style.top=(topY-(isMobile?38:50))+'px';a.style.left=b.x+'px';a.style.display='block';h.textContent=isMobile?'Tap!':'Click!';}
function initAll(){bgFlowers=[];bgFQ=[];posIdx=0;clickNum=0;allPos=makeBgPos();initBuds();initClouds();initSnow();allDone=false;revT=0;duck.active=false;chip.active=false;geese.active=false;roo.active=false;pRat.active=false;animalTimer=0;sunProg=0;sunRising=false;if(audio){audio.pause();audio=null;}musicPlaying=false;document.getElementById('muteBtn').style.display='none';document.getElementById('poem').style.opacity='0';updateHint();}
initAll();

// === DRAWING ===
function drawSky(t){skyH=H*(isMobile?0.28:0.30);if(sunRising&&sunProg<1)sunProg=Math.min(sunProg+0.003,1);let p=sunProg;
  let top,mid,bot;if(p<0.5){let q=p*2;top=lerpC('#2a1a40','#664488',q);mid=lerpC('#cc6622','#dd8866',q);bot=lerpC('#ffaa44','#ffcc88',q);}else{let q=(p-0.5)*2;top=lerpC('#664488','#4488cc',q);mid=lerpC('#dd8866','#66aadd',q);bot=lerpC('#ffcc88','#88ccee',q);}
  let g=ctx.createLinearGradient(0,0,0,skyH);g.addColorStop(0,top);g.addColorStop(0.5,mid);g.addColorStop(1,bot);ctx.fillStyle=g;ctx.fillRect(0,0,W,skyH);
  let sunR=isMobile?30:50;let sunStartY=skyH+sunR*0.8;let sunEndY=-sunR*2.5;let sunY=sunStartY+(sunEndY-sunStartY)*p;let sunX=W*(isMobile?0.78:0.80);let sunCol=lerpC('#ff8800','#ffee44',p);let sunHi=lerpC('#ffcc33','#ffffaa',p);let sunEdge=lerpC('#ff6600','#ffdd33',p);
  let glowA=Math.max(0,0.5-p*0.3);if(glowA>0){let gw=sunR*8,gh=sunR*4;let hg=ctx.createRadialGradient(sunX,sunY,sunR*0.5,sunX,sunY,gw);hg.addColorStop(0,'rgba(255,200,80,'+glowA*0.7+')');hg.addColorStop(0.3,'rgba(255,140,40,'+glowA*0.4+')');hg.addColorStop(0.7,'rgba(255,80,20,'+glowA*0.15+')');hg.addColorStop(1,'rgba(255,60,10,0)');ctx.fillStyle=hg;ctx.fillRect(0,Math.max(0,sunY-gh),W,gh*2);let ig=ctx.createRadialGradient(sunX,sunY,sunR*0.2,sunX,sunY,sunR*3);ig.addColorStop(0,'rgba(255,240,180,'+glowA*0.6+')');ig.addColorStop(0.5,'rgba(255,180,60,'+glowA*0.3+')');ig.addColorStop(1,'rgba(255,120,20,0)');ctx.fillStyle=ig;ctx.fillRect(sunX-sunR*3,Math.max(0,sunY-sunR*3),sunR*6,sunR*6);}
  if(sunY>-sunR*1.5){let rayCount=16;let rayAlpha=Math.max(0,0.8-p*0.5);if(rayAlpha>0){let dashLen=isMobile?7:11,gapLen=isMobile?5:7,dashSpeed=t*0.06;for(let i=0;i<rayCount;i++){let ang=(i/rayCount)*Math.PI*2+t*0.0004;let maxLen=sunR*(3.5+Math.sin(t*0.002+i*0.9)*0.8);let rw=isMobile?3:4;let rx=Math.cos(ang),ry=Math.sin(ang);let iAlpha=rayAlpha*(0.7+Math.sin(t*0.004+i*2.1)*0.3);let rayCol=lerpC('#ffaa00','#ffee44',p);ctx.fillStyle=rayCol;let offset=(dashSpeed+i*7)%(dashLen+gapLen);for(let d=sunR*1.1-offset;d<sunR*1.1+maxLen;d+=dashLen+gapLen){if(d<sunR*1.0)continue;let fadeOut=1-Math.max(0,(d-sunR*1.1)/(maxLen))*0.7;ctx.globalAlpha=iAlpha*fadeOut;for(let dd=0;dd<dashLen;dd+=3){let dist=d+dd;let px2=sunX+rx*dist,py2=sunY+ry*dist;ctx.fillRect(Math.floor(px2)-1,Math.floor(py2)-1,rw,rw);}}}ctx.globalAlpha=1;}}
  if(sunY>-sunR*1.5){ctx.save();ctx.beginPath();ctx.rect(0,0,W,skyH);ctx.clip();let coronaR=sunR+4;for(let dy=-coronaR;dy<=coronaR;dy+=3){let dx=Math.sqrt(Math.max(0,coronaR*coronaR-dy*dy));if(dx>0){ctx.globalAlpha=0.4;pBox(sunX-dx,sunY+dy,dx*2,3,lerpC('#ff4400','#ffcc22',p));}}ctx.globalAlpha=1;for(let dy=-sunR-2;dy<=sunR+2;dy+=3){let dx=Math.sqrt(Math.max(0,(sunR+2)*(sunR+2)-dy*dy));if(dx>0)pBox(sunX-dx,sunY+dy,dx*2,3,sunEdge);}for(let dy=-sunR;dy<=sunR;dy+=3){let dx=Math.sqrt(Math.max(0,sunR*sunR-dy*dy));if(dx>0){let distC=Math.abs(dy)/sunR;let bodyCol=lerpC(sunHi,sunCol,distC*0.7);pBox(sunX-dx,sunY+dy,dx*2,3,bodyCol);}}for(let dy=-sunR*0.8;dy<=-sunR*0.1;dy+=3){let dx=Math.sqrt(Math.max(0,(sunR*0.75)*(sunR*0.75)-dy*dy))*0.9;if(dx>0){ctx.globalAlpha=0.5;pBox(sunX-dx-sunR*0.05,sunY+dy,dx*1.5,3,'#ffffdd');}}ctx.globalAlpha=1;let cR=sunR*0.3;for(let dy=-cR;dy<=cR;dy+=3){let dx=Math.sqrt(Math.max(0,cR*cR-dy*dy));if(dx>0){ctx.globalAlpha=0.5;pBox(sunX-dx,sunY+dy-sunR*0.05,dx*2,3,'#ffffff');}}ctx.globalAlpha=1;ctx.restore();}
  let bc,gc;if(p<0.5){let q=p*2;bc=lerpC('#ddaa55','#ddcc88',q);gc=lerpC('#886622','#448833',q);}else{let q=(p-0.5)*2;bc=lerpC('#ddcc88','#88ccee',q);gc=lerpC('#448833','#55aa55',q);}for(let x=0;x<W;x+=4){pRect(x,skyH-4,4,bc);pRect(x,skyH,4,gc);}
  ctx.globalAlpha=0.2+p*0.8;clouds.forEach(c=>{c.x+=c.speed;if(c.x>W+c.w)c.x=-c.w*2;drawCloud(c);});ctx.globalAlpha=1;}
function drawGround(){let p=sunProg;let snowTint=Math.max(0,1-p*2.5);let c1,c2,c3;if(p<0.5){let q=p*2;c1=lerpC('#1a3a1a','#226622',q);c2=lerpC('#0e2a0e','#184418',q);c3=lerpC('#081a08','#0c2c0c',q);}else{let q=(p-0.5)*2;c1=lerpC('#226622','#2d8b2d',q);c2=lerpC('#184418','#1a5c1a',q);c3=lerpC('#0c2c0c','#0d3d0d',q);}let g=ctx.createLinearGradient(0,skyH,0,H);g.addColorStop(0,c1);g.addColorStop(0.3,c2);g.addColorStop(1,c3);ctx.fillStyle=g;ctx.fillRect(0,skyH,W,H-skyH);for(let x=0;x<W;x+=6)for(let y=Math.floor(skyH);y<H;y+=40){let s=Math.sin(x*0.03+y*0.02)*10,gv=(55+p*35)+s+Math.sin(x*0.1)*5;ctx.fillStyle=`rgb(${Math.floor(12+p*8+s/3)},${Math.floor(gv)},${Math.floor(12+p*8+s/3)})`;ctx.fillRect(x,y+Math.sin(x*0.05)*3,4,3);}  if(snowTint>0){ctx.globalAlpha=snowTint*0.4;ctx.fillStyle='#d0d8ee';ctx.fillRect(0,skyH-6,W,H-skyH+6);ctx.globalAlpha=1;}}
function drawSnow(t){if(sunProg>=1)return;let alpha=Math.max(0,1-sunProg*2);if(alpha<=0)return;ctx.globalAlpha=alpha;snowFlakes.forEach(s=>{ctx.fillStyle=`rgba(240,244,255,${s.bright})`;ctx.fillRect(Math.floor(s.x),Math.floor(s.y),s.size,s.size*0.5);});let skyBot=H*(isMobile?0.28:0.30);
  // Thick snow covering the horizon line completely
  pBox(0,skyBot-6,W,14,'#e8edff');
  pBox(0,skyBot-3,W,8,'#f0f4ff');
  // Snow drifts across entire field
  for(let x=-10;x<W+10;x+=20){let dy=Math.sin(x*0.03)*4;
    pBox(x,skyBot+dy+6,30+Math.sin(x*0.07)*12,7,'#eef2ff');
    pBox(x+5,skyBot+dy+12,22,5,'#dde4f4');
    pBox(x+8,skyBot+H*0.15+dy*1.5,28+Math.sin(x*0.09)*10,6,'#e8edfa');
    pBox(x+3,skyBot+H*0.3+dy*2,24+Math.sin(x*0.05)*8,5,'#dde4f4');
    pBox(x+6,skyBot+H*0.5+dy,26+Math.sin(x*0.06)*10,6,'#e8edfa');
    pBox(x+4,H-12+dy*0.5,28+Math.sin(x*0.08)*8,7,'#eef2ff');}
  ctx.globalAlpha=alpha*0.35;ctx.fillStyle='#e8edff';ctx.fillRect(0,skyBot,W,H-skyBot);ctx.globalAlpha=alpha;fallingSnow.forEach(s=>{s.y+=s.speed;s.drift+=s.driftSpeed;s.x+=Math.sin(s.drift)*0.5;if(s.y>H){s.y=-5;s.x=Math.random()*W;}if(s.x<-5)s.x=W+5;if(s.x>W+5)s.x=-5;ctx.fillStyle=`rgba(255,255,255,${s.bright})`;ctx.fillRect(Math.floor(s.x),Math.floor(s.y),s.size,s.size);});ctx.globalAlpha=1;}
function drawBgF(f,t){let gp=Math.min(f.gp,1);if(gp<=0)return;let sw=Math.sin(t*0.0015+f.phase)*2.5*gp,px=f.x+sw,py=f.y,s=Math.floor(f.size*gp);if(s<1)return;let sh=f.stemH*gp;for(let sy=0;sy<sh;sy+=3){let w=Math.sin(sy*0.08+t*0.002+f.phase)*1.5;pRect(px+w,py+sy,2,'#2d6b2d');}if(gp>0.3){pRect(px-4,py+sh*0.5,3,'#3da33d');pRect(px+3,py+sh*0.6,3,'#3da33d');}if(gp<0.5)return;if(f.type===4){
  // Green sapling - just leaves, no flower
  pRect(px-s,py-s,s,'#3da33d');pRect(px+1,py-s-1,s,'#44aa44');pRect(px-s+1,py+1,s,'#2d8b2d');pRect(px+1,py,s-1,'#55bb55');
}else if(f.type===0){pRect(px-s,py-s,s,f.col);pRect(px+2,py-s,s,f.col);pRect(px-s,py+2,s,f.col);pRect(px+2,py+2,s,f.col);pRect(px,py,2,'#ffee44');}else if(f.type===1){pRect(px-1,py-s-1,s,f.col);pRect(px-s-1,py,s,f.col);pRect(px+2,py,s,f.col);pRect(px-1,py+s+1,s,f.col);pRect(px,py,3,'#ffee44');}else if(f.type===2){for(let a=0;a<5;a++){let ax=Math.cos(a*Math.PI*2/5)*s,ay=Math.sin(a*Math.PI*2/5)*s;pRect(px+ax,py+ay,s-1,f.col);}pRect(px,py,3,'#ffcc00');}else{pBox(px-s/2,py-s,s+1,s,f.col);pBox(px-s/2-1,py-s+2,s+3,s-2,f.col);pRect(px,py,2,'#ffcc00');}}
function drawPixelLetter(l,cx,cy,sc,col,al){let g=LETTERS[l];if(!g)return;ctx.globalAlpha=al;ctx.fillStyle=col;let ox=cx-(5*sc)/2,oy=cy-(7*sc)/2;for(let r=0;r<7;r++)for(let c=0;c<5;c++)if(g[r][c])ctx.fillRect(Math.floor(ox+c*sc),Math.floor(oy+r*sc),sc,sc);ctx.globalAlpha=1;}
function drawBud(b,t){let ps=isMobile?0.7:1,sway=Math.sin(t*0.002+b.wobble)*4*ps,bx=b.drawX+sway,by=b.drawY,p=b.bloomProgress,gi=b.growIn,sh=b.drawStemH;let stemTop=by-sh*Math.min(p+0.3,1)*gi;for(let sy=by;sy>stemTop;sy-=3){let sw=Math.sin((sy-by)*0.04+t*0.002+b.wobble)*3;pRect(bx+sw-1,sy,4,'#2d8b2d');}let leafY=by-sh*0.4*gi,ls=Math.sin(t*0.003+b.leafPhase)*3,leafS=isMobile?4:6;if(gi>0.4){let la=Math.min((gi-0.4)/0.3,1);ctx.globalAlpha=la;pRect(bx-14*ps+ls,leafY,leafS,'#3da33d');pRect(bx-10*ps+ls,leafY-4*ps,leafS,'#2d8b2d');pRect(bx-7*ps+ls,leafY-7*ps,leafS-1,'#3da33d');pRect(bx+8*ps-ls,leafY+6*ps,leafS,'#2d8b2d');pRect(bx+6*ps-ls,leafY+2*ps,leafS,'#3da33d');pRect(bx+10*ps-ls,leafY+9*ps,leafS-1,'#2d8b2d');ctx.globalAlpha=1;}
let fY=stemTop;if(!b.bloomed){if(gi<0.7)return;let ba=Math.min((gi-0.7)/0.3,1);ctx.globalAlpha=ba;let bs=isMobile?10:14;
    // Seedling sprout üå± style
    let leafW=bs*0.7,leafH=bs*0.5;
    // Left leaf
    pBox(bx-leafW-1,fY-leafH*1.8,leafW,leafH,'#44aa44');
    pBox(bx-leafW+1,fY-leafH*2.2,leafW-2,leafH*0.6,'#55cc55');
    pBox(bx-leafW+2,fY-leafH*1.5,leafW*0.4,leafH*0.3,'#66dd66');
    // Right leaf
    pBox(bx+2,fY-leafH*1.8,leafW,leafH,'#44aa44');
    pBox(bx+2,fY-leafH*2.2,leafW-2,leafH*0.6,'#55cc55');
    pBox(bx+leafW*0.4,fY-leafH*1.5,leafW*0.4,leafH*0.3,'#66dd66');
    // Center stem nub between leaves
    pBox(bx-1,fY-leafH*2.5,3,leafH*1.2,'#3d9b3d');
    pBox(bx-1,fY-leafH*0.8,3,leafH*0.8,'#2d8b2d');
    // Shimmer
    ctx.globalAlpha=ba*(0.3+Math.sin(t*0.004+b.wobble)*0.2);pRect(bx-leafW+2,fY-leafH*2,2,2,'#88ee88');ctx.globalAlpha=1;
}else{let bp=Math.min(p,1),sp2=bp*22*ps,pz=Math.floor((7+bp*7)*ps);for(let a=0;a<8;a++){let ang=(a/8)*Math.PI*2+Math.sin(t*0.001)*0.1,px=bx+Math.cos(ang)*sp2,py=fY-8*ps+Math.sin(ang)*sp2*0.7;pBox(px-pz/2,py-pz/2,pz,pz,b.petalCol);}let ms=Math.floor(8*ps);for(let a=0;a<6;a++){let ang=(a/6)*Math.PI*2+0.3,px=bx+Math.cos(ang)*sp2*0.55,py=fY-8*ps+Math.sin(ang)*sp2*0.4;pBox(px-ms/2,py-ms/2,ms,ms,b.midCol);}let is2=Math.floor(6*ps);for(let a=0;a<4;a++){let ang=(a/4)*Math.PI*2+0.5,px=bx+Math.cos(ang)*sp2*0.3,py=fY-8*ps+Math.sin(ang)*sp2*0.2;pBox(px-is2/2,py-is2/2,is2,is2,b.innerCol);}let cs2=Math.floor(10*ps);pBox(bx-cs2/2,fY-13*ps,cs2,cs2,'#ffee44');pBox(bx-cs2/2+1,fY-12*ps,cs2-2,cs2-2,b.centerCol);if(bp>0.3){let la=Math.min((bp-0.3)/0.5,1),lsc=isMobile?3:4,ly=fY-(isMobile?32:48)-Math.sin(t*0.003+b.wobble)*5;ctx.globalAlpha=la*0.15;ctx.fillStyle=b.petalCol;ctx.fillRect(bx-12,ly-14,24,28);ctx.globalAlpha=1;drawPixelLetter(b.letter,bx+2,ly+2,lsc,'#220011',la*0.6);drawPixelLetter(b.letter,bx,ly,lsc,'#ffffff',la);}}}
function spawnH(x,y,col){for(let i=0;i<8;i++)hearts.push({x,y:y-40,vx:(Math.random()-0.5)*4,vy:-Math.random()*3-1,life:1,size:5+Math.random()*6,col});}
function spawnS(x,y){for(let i=0;i<14;i++)sparkles.push({x,y:y-40,vx:(Math.random()-0.5)*5,vy:(Math.random()-0.5)*5,life:1,col:['#ffee44','#ffffff','#ff9ecf','#ffcc00','#ff6b9d'][Math.floor(Math.random()*5)]});}
function drawHeart(x,y,s,col,al){ctx.globalAlpha=al;pRect(x-s,y-s,s,col);pRect(x+s,y-s,s,col);pRect(x-2*s,y,s,col);pRect(x-s,y,s,col);pRect(x,y,s,col);pRect(x+s,y,s,col);pRect(x+2*s,y,s,col);pRect(x-s,y+s,s,col);pRect(x,y+s,s,col);pRect(x+s,y+s,s,col);pRect(x,y+2*s,s,col);ctx.globalAlpha=1;}

// === CLICK ===
function handleClick(mx,my){let idx=-1;for(let i=0;i<buds.length;i++)if(!buds[i].bloomed&&buds[i].visible&&buds[i].growIn>=0.9){idx=i;break;}if(idx<0)return;let b=buds[idx];if(Math.abs(mx-b.x)<35&&(my-b.y)>-b.stemH-30&&(my-b.y)<10){b.bloomed=true;spawnH(b.x,b.y-b.stemH,b.petalCol);spawnS(b.x,b.y-b.stemH);spawnBgBatch(CS[idx]);if(idx+1<buds.length)buds[idx+1].visible=true;if(idx===0){sunRising=true;startMusic();}if(idx===1&&!chip.active)startChipmunk();if(idx===3&&!duck.active)startDuck();if(idx===5&&!roo.active)startKangaroo();if(idx===6&&!geese.active)startGeese();updateHint();if(!allDone&&buds.every(b=>b.bloomed)){allDone=true;revT=0;document.getElementById('hint').style.display='none';document.getElementById('hintArrow').style.display='none';let maxY=0;buds.forEach(b=>{if(b.y>maxY)maxY=b.y;});document.getElementById('poem').style.top=(maxY+(isMobile?60:90))+'px';document.getElementById('poem').style.opacity='1';for(let i=0;i<30;i++)setTimeout(()=>{hearts.push({x:W*0.1+Math.random()*W*0.8,y:H*0.5+Math.random()*H*0.3,vx:(Math.random()-0.5)*5,vy:-Math.random()*4-2,life:1,size:4+Math.random()*6,col:['#ff4455','#ffdd33','#4488ff','#aa55dd'][Math.floor(Math.random()*4)]});},i*60);}}}
C.addEventListener('click',e=>handleClick(e.clientX,e.clientY));
C.addEventListener('touchstart',e=>{e.preventDefault();handleClick(e.touches[0].clientX,e.touches[0].clientY);},{passive:false});

// === MAIN LOOP ===
function loop(t){ctx.clearRect(0,0,W,H);drawSky(t);drawGround();drawSnow(t);bgFQ.forEach(f=>{if(f.delay>0){f.delay--;return;}if(f.gp<1)f.gp+=f.gs;if(f.gp>=1&&!f.done){f.done=true;bgFlowers.push(f);}});bgFQ=bgFQ.filter(f=>!f.done);bgFlowers.forEach(f=>drawBgF(f,t));bgFQ.forEach(f=>{if(f.delay<=0)drawBgF(f,t);});buds.forEach(b=>{if(b.bloomed&&b.bloomProgress<1)b.bloomProgress+=0.015;if(b.visible&&b.growIn<1)b.growIn=Math.min(b.growIn+0.025,1);});buds.forEach(b=>{if(b.visible)drawBud(b,t);});updateHint();updateDuck();drawDuck(t);updateChipmunk();drawChipmunk();updateGeese();drawGeese();updateKangaroo();drawKangaroo(t);updatePizzaRat();drawPizzaRat(t);hearts=hearts.filter(h=>{h.x+=h.vx;h.y+=h.vy;h.vy-=0.02;h.life-=0.01;if(h.life>0){drawHeart(h.x,h.y,h.size/3,h.col,h.life);return true;}return false;});sparkles=sparkles.filter(s=>{s.x+=s.vx;s.y+=s.vy;s.life-=0.018;if(s.life>0){ctx.globalAlpha=s.life;pRect(s.x,s.y,4,s.col);ctx.globalAlpha=1;return true;}return false;});if(allDone){revT++;if(revT%45===0)hearts.push({x:Math.random()*W,y:H+10,vx:(Math.random()-0.5)*1,vy:-Math.random()*1.5-0.5,life:1,size:4+Math.random()*7,col:['#ff4455','#ffdd33','#4488ff','#aa55dd'][Math.floor(Math.random()*4)]});
    // Hearts from SOHLANGE letters
    if(revT%30===0){let ri=Math.floor(Math.random()*buds.length);let rb=buds[ri];let ps2=isMobile?0.7:1;let sway2=Math.sin(revT*0.002+rb.wobble)*4*ps2;let bx2=rb.drawX+sway2;let stemTop2=rb.drawY-rb.drawStemH*Math.min(rb.bloomProgress+0.3,1);let ly2=stemTop2-(isMobile?32:48);hearts.push({x:bx2,y:ly2,vx:(Math.random()-0.5)*2,vy:-Math.random()*1.5-0.5,life:1,size:3+Math.random()*4,col:rb.petalCol});}
    animalTimer++;if(animalTimer>=animalInterval){animalTimer=0;animalInterval=180+Math.floor(Math.random()*180);spawnRandomAnimal();}}requestAnimationFrame(loop);}
requestAnimationFrame(loop);
window.addEventListener('resize',()=>{resize();initAll();});
</script>
</body>
</html>
